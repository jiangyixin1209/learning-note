# 日志

## redo log(重做日志)

### 什么是 redo log

redo log 是InnoDB引擎特有的日志。

在InnoDB中有 `buffer pool`，它是数据库页面的缓存。对InnoDB的任何修改都会现在 `buffer pool` 的 `page` 上执行，然后这样的 `page` 被标记为dirty并放入 `flush list` 上，并且由后续的 master thread 或者专门刷脏数据的线程阶段性的将这些页面写入磁盘。这样的好处是避免了每次数据操作都去操作磁盘导致产生大量的随机IO。阶段性刷脏操作可以把对页面的多次操作merge成一次IO操作，同时异步写入也降低了访问的时间延迟。但是，如果在 `dirty page` 未被写入磁盘之前，`MySQL Server` 由于异常而非正常关闭，那么这些操作将会丢失。如果此时写入操作正在进行，还会由于数据文件损坏而导致数据库不可用。为了防止上述情况的发生，InnoDB将所有对页面的修改操作写入一个专门的文件，并在数据库启动时对此文件进行恢复操作，这个文件就是 `redo log`。使用 `redo log` 推迟了 `buffer pool` 页面的更新，增加了数据库的吞吐，有效降低了访问的延迟。带来的是额外的写 `redo log` 操作的开销(顺序IO，开销很小)，已经数据库启动时恢复操作所需要的时间。

### 记录 redo log 的流程

以 `update t set k = 1 where id = 2` 这句SQL为例来看看 `redo log` 的记录流程

* MySQL Client 将这条SQL发送到 MySQL Server
* MySQL Server 解析这条SQL发送 将 id=2行上列a的值改为 2 至 InnoDB 引擎
* InnoDB将修改的结果更新到内存里
* InnoDB记录 redo log ，内容大致为：在n数据页上的m地方做x修改，并将这条记录的状态置为 prepare
* InnoDB告诉 MySQL Server 可以提交事务了
* MySQL Server 向 InnoDB 提交事务
* InnoDB 将这条 redo log 记录的状态置为 commit

上述过程将 redo log 写入拆成了两个步骤，prepare 和 commit ，这就两提交。

### redo log 的存储

redo log 的大小是固定的，比如可以配置为一组4个文件，每个文件大小为1GB，那么 redo log 总共可记录4GB的内容。redo log 采用的是类似于环形的记录方式，一般会有两个记录的指针：`write pos` 和 `checkpoint` 。`write pos` 记录的是当前的位置，一边写一边后移。 `checkpoint` 是当前要擦除的位置，同样也是一边擦除一边后移，擦除记录之前会把记录更新到数据文件。

`write pos` 和 `checkpoint` 之间的是还空着的部分，可以用来记录新的操作。如果 `write pos` 追上 `checkpoint` ，表示空间满了，这时候不能再执行新的更新，得停下来先擦掉一些记录，把 `checkpoint` 推进一下。

### 为什么需要 redo log


## binlog(归档日志)