有没有想过Python在背后如何处理你的数据？你的变量如何存储在内存中？以及它们什么时候被删除？

在本文中，我们将深入研究Python的内部机制，来了解它如何进行内存管理。

**在本文结束时，你将：**

- 了解有关底层计算的更多信息，特别是与内存相关的信息
- 了解Python如何抽象底层操作
- 了解Python内部的内存管理算法

了解Python的内部结构还可以让你更好地了解Python的一些行为。希望你也能获得对Python的新认识。Python在背后处理了大量的逻辑，以确保你的程序以期望的方式运行。

# 内存是一本空的书籍

你可以将计算机的内存想象成一本用于存储短篇小说的空书。页面上还没有任何内容。最终，会出现不同的作者，每个作者都想要一些空间来写他们的故事。

由于他们不允许彼此书写，因此他们必须小心他们写的页面。在他们开始写作之前，他们会咨询书的管理员。然后管理员决定他们允许写书的位置。

由于这本书已经存在了很长时间，因此其中的许多故事已不再适用。当没有人阅读或引用这些故事时，它们会被移除以为新故事腾出空间。

从本质上讲，计算机内存就像那本空书。事实上，调用固定长度的连续内存**页**块是很常见的，所以这个类比非常好。

作者就像需要将数据存储在内存中的不同应用程序或进程。而决定作者在书中可以书写位置的管理员则内存管理器。删除旧故事来为新故事腾出空间的人则是垃圾收集者。

***

# 内存管理：从硬件到软件

内存管理是应用程序读写数据的过程。内存管理器确定应用程序存放数据的位置。由于存在一定数量的内存块，就像我们类比书中的页面一样，管理器必须找到一些可用空间并将其提供给应用程序。这种提供内存的过程通常称为内存**分配**。

另一方面，当不再需要数据时，可以删除或**释放数据**。但释放到哪里？这个“内存”从何而来？

在计算机的某个地方，有一个物理设备在运行你的Python程序时存储数据。在对象实际到达硬件之前，Python代码经历了许多抽象层。

硬件上主要层之一（例如RAM或硬盘驱动器）是操作系统（OS）。它执行（或拒绝）读写内存的请求。

在OS之上，有一些应用程序，其中一个是默认的Python实现（包含在你的操作系统中或从[python.org](https://www.python.org/)下载。）Python代码的内存管理由Python应用程序处理。Python应用程序用于内存管理的算法和数据结构是本文的重点。

***

# 默认的Python实现

默认的Python实现是CPython，它实际上是用C编程语言编写的。

当我第一次听到这个时，它引起了我的注意。用另一种语言写的语言？！嗯，不是真的，但有点儿。

Python语言在用英语编写的[参考手册中](https://docs.python.org/3/reference/index.html)定义。但是，该手册本身并不是那么有用。你仍然需要根据手册中的规则来编写的代码。

你还需要在计算机上实际执行解释的代码。默认的Python实现满足这两个要求。它将你的Python代码转换为随后在虚拟机上运行的指令。

> **注意**: 虚拟机就像物理计算机，但它们是用软件实现的。它们通常处理类似于[汇编指令](https://en.wikipedia.org/wiki/Assembly_language)的基本[指令](https://en.wikipedia.org/wiki/Assembly_language)。

Python是一种解释性编程语言。你的Python代码实际上被编译为更计算机可读的指令，称为[字节码](https://docs.python.org/3/glossary.html#term-bytecode)。当运行代码时，这些指令将由虚拟机进行**解释**。

你见过`.pyc`文件或`__pycache__`文件夹吗？这是由虚拟机解释出的字节码。

值得注意的是，Python除了CPython之外还有其他实现。[IronPython](http://ironpython.net/)将代码编译成能在Microsoft的公共语言运行时运行。[Jython](http://www.jython.org/)将代码编译为Java字节码以在Java虚拟机上运行。然后是[PyPy](https://pypy.org/)，但它应该值得用一片完整的文章来讲解，所以我只是顺便提一下。

出于本文的目的，我将重点介绍由Python的默认实现（CPython）完成的内存管理。

> **免责声明**：虽然很多这些信息将贯穿新版本的Python，但未来可能会发生变化。请注意，本文的引用版本是Python的当前最新版本[`3.7`](https://realpython.com/python37-new-features/)。

好的，所以CPython是用C语言编写的，它解释了Python字节码。这与内存管理有什么关系？内存管理算法和数据结构存在于用C编写的CPython代码中。要理解Python的内存管理，你必须对CPython本身有一个基本的了解。

CPython是用C语言编写的，它本身不支持面向对象的编程。因此，CPython代码中有相当多的有趣设计。

你可能听说过Python中的所有内容都是一个对象，甚至类似于`int`和`str`。这在CPython的实现级别上是正确的。这是一个被叫做 `PyObject`的`结构体`，CPython中的每个其他对象都使用它。

> **注意：** C中的结构体或结构是一种自定义数据类型，它将不同的数据类型组合在一起。要与面向对象的语言进行比较，它就像一个具有属性而没有方法的类。

这个`PyObject`，Python中的所有对象的父类，只包含两个属性：

- **ob_refcnt：**引用计数
- **ob_type：**指向另一种类型的指针

引用计数用于垃圾回收。然后有一个指向实际对象类型的指针。该对象类型只是用来描述Python对象（例如 `dict`或`int`）的另一种结构体类型。

每个对象都有自己的特定于对象的内存分配器，它知道如何获取内存来存储该对象。每个对象还有一个特定于对象的内存释放器，一旦不再需要就会“释放”内存。

但是，所有关于分配和释放内存的讨论都有一个重要因素。内存是计算机上的共享资源，如果两个不同的进程尝试同时写入同一位置，则可能会发生错误。

